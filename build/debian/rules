#!/usr/bin/make -f

build:
	touch build-stamp
	test -n "${SUDO_USER}" && chown "${SUDO_USER}" build-stamp

clean:
	-rm -f build
	-rm -rf debian/*substvars debian/tmp debian/files

binary:	binary-indep binary-arch

binary-indep:	checkroot build
	@rm -rf debian/tmp
	#Create the directories:
	install -d debian/tmp/DEBIAN
	install -d debian/tmp/sbin/
	install -d debian/tmp/usr/sbin
	install -d debian/tmp/etc/sanewall
	install -d debian/tmp/etc/sanewall/services
	install -d debian/tmp/etc/default
	install -d debian/tmp/etc/init.d
	install -d debian/tmp/usr/share/man/man1/
	install -d debian/tmp/usr/share/man/man5/
	install -d debian/tmp/usr/share/doc/sanewall
	install -d debian/tmp/usr/share/doc/sanewall/html
	install -d debian/tmp/usr/share/doc/sanewall/admin
	install -d debian/tmp/usr/share/doc/sanewall/examples

	#Install the scripts and the config:
	install -m 755 ../sanewall debian/tmp/sbin/sanewall
	install -m 755 ../init.d/sanewall debian/tmp/etc/init.d/sanewall
	install -m 644 ../examples/client-all.conf debian/tmp/etc/sanewall/sanewall.conf
	install -m 644 ../etc/RESERVED_IPS debian/tmp/etc/sanewall
	install -m 755 ../admin/get-iana.sh debian/tmp/usr/sbin/get-iana

	echo "#To enable sanewall at startup set START_SANEWALL=YES" > debian/tmp/etc/default/sanewall
	echo "START_SANEWALL=NO" >> debian/tmp/etc/default/sanewall
	echo "#If you want to have sanewall wait for an iface to be up add it here" >> debian/tmp/etc/default/sanewall
	echo 'WAIT_FOR_IFACE=""' >> debian/tmp/etc/default/sanewall
	
	chmod 644 debian/tmp/etc/default/sanewall

	#Copy the documentation:
	install -m 644 ../doc/*.html ../doc/*.css debian/tmp/usr/share/doc/sanewall/html/
	install -m 644 ../man/man1/sanewall.1 debian/tmp/usr/share/man/man1/
	install -m 644 ../man/man1/get-iana.1 debian/tmp/usr/share/man/man1/
	install -m 644 ../man/man5/sanewall.conf.5 debian/tmp/usr/share/man/man5/
	gzip -9 debian/tmp/usr/share/man/man1/sanewall.1 debian/tmp/usr/share/man/man5/sanewall.conf.5 debian/tmp/usr/share/man/man1/get-iana.1

	#Copy the examples:
	install -m 644 ../examples/*.conf debian/tmp/usr/share/doc/sanewall/examples/
	# Admin scripts
	install -m 644 ../admin/adblock.sh  debian/tmp/usr/share/doc/sanewall/admin/
	install -m 644 ../admin/check-iana.sh  debian/tmp/usr/share/doc/sanewall/admin/

	#Copyright, Changelog, etc:
	install -m 644 debian/copyright debian/tmp/usr/share/doc/sanewall/
	install -m 644 ../ChangeLog debian/tmp/usr/share/doc/sanewall/changelog
	gzip -9 debian/tmp/usr/share/doc/sanewall/changelog

	install -m 644 ../README debian/tmp/usr/share/doc/sanewall/
	install -m 644 ../INSTALL debian/tmp/usr/share/doc/sanewall/

	#Create MD5-Sums:
	(cd debian/tmp; find -type f | sed s#^./## | grep -v DEBIAN | xargs md5sum > DEBIAN/md5sums)
	chmod 644 debian/tmp/DEBIAN/md5sums

	# Standard package building stuff
	install -m755 debian/preinst debian/tmp/DEBIAN
	install -m755 debian/postinst debian/tmp/DEBIAN
	install -m755 debian/postrm debian/tmp/DEBIAN
	install -m644 debian/conffiles debian/tmp/DEBIAN
	dpkg-gencontrol -psanewall -is -ip -l../ChangeLog
	chmod 644 debian/tmp/DEBIAN/control
	chown -R root:root debian/tmp
	dpkg --build debian/tmp .
	test -n "${SUDO_USER}" && chown "${SUDO_USER}" *.deb
	@rm -rf debian/tmp

binary-arch:	checkroot build
	# No architecture dependent packages

checkroot:
	test root = "`whoami`"

.PHONY: binary clean binary-indep binary-arch build install clean
